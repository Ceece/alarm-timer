<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>alarm-timer</title>
  <meta name="theme-color" content="#0d47a1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
  <style>
    body {
      max-width: 400px;
    }

    label {
      display: block;
      margin: 1em 0 0.5em;
    }

    #status {
      margin-top: 1em;
      color: green;
    }

    input {
      text-align: center;
      width: calc(100% - 20px);
      font-size: 36px;
    }

    button {
      font-size: 24px;
    }
  </style>
</head>

<body>
  <h1>üîî alarm-timer</h1>

  <label>
    Start Time:
    <input type="time" id="startTime" value="00:00">
  </label>

  <label>
    Interval (minutes):
    <input type="number" id="interval" value="30" min="1">
  </label>

  <button id="toggle" onclick="toggleAlarm()">Start Alarm</button>
  <br />
  <button onclick="toggleAlarm('01:29', 90)">MVP</button>
  <button onclick="toggleAlarm('00:29', 30)">Mini</button>

  <p id="nextAlarmText">Next alarm: -</p>
  <p id="status"></p>

  <audio id="alarmSound" src="alarm_clock.ogg" preload="auto"></audio>

  <script>
    const startTimeInput = document.getElementById("startTime");
    const intervalInput = document.getElementById("interval");
    const toggleButton = document.getElementById("toggle");
    const nextAlarmText = document.getElementById("nextAlarmText");
    const statusText = document.getElementById("status");
    const alarmSound = document.getElementById("alarmSound");

    let alarmOn = false;
    let nextAlarmTime = null;
    let checkInterval = null;

    // üîî Request Notification permission
    if (Notification.permission !== "granted") {
      Notification.requestPermission();
    }

    function sendNotification(message) {
      if (Notification.permission === "granted") {
        new Notification(message);
      }
    }

    function playSound() {
      alarmSound.currentTime = 0;
      alarmSound.play().catch(err => console.warn("Sound error:", err));
    }

    function updateNextAlarmFrom(fromTime) {
      const [startHour, startMinute] = startTimeInput.value.split(":").map(Number);
      const interval = parseInt(intervalInput.value, 10);

      let base = new Date();
      base.setHours(startHour, startMinute, 0, 0);

      while (base <= fromTime) {
        base = new Date(base.getTime() + interval * 60000);
      }

      nextAlarmTime = base;
      nextAlarmText.textContent = "Next alarm: " + base.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    function updateNextAlarm() {
      updateNextAlarmFrom(new Date());
    }

    function triggerAlarm() {
      const message = `‚è∞ Alarm time: ${nextAlarmTime.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}`;
      sendNotification(message);
      playSound();

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° delay 1 ‡∏ß‡∏¥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á alarm ‡∏ã‡πâ‡∏≥‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏¥‡∏°
      setTimeout(() => updateNextAlarm(), 1000);
    }

    function checkAlarm() {
      if (!alarmOn || !nextAlarmTime) return;

      const now = new Date();
      if (
        now.getHours() === nextAlarmTime.getHours() &&
        now.getMinutes() === nextAlarmTime.getMinutes() &&
        now.getSeconds() === 0
      ) {
        triggerAlarm();
      }
    }

    function toggleAlarm(time, interval) {

      if (time) {
        startTimeInput.value = time;
        resetAlarm()
      }

      if (interval) {
        intervalInput.value = interval;
        resetAlarm()
      }

      alarmOn = !alarmOn;

      if (alarmOn) {
        updateNextAlarm();
        checkInterval = setInterval(checkAlarm, 1000);
        toggleButton.textContent = "Stop Alarm";
        statusText.textContent = "‚è± Alarm is ON";
        statusText.style.color = "green";
      } else {
        resetAlarm();
      }
    }

    function resetAlarm() {
      alarmOn = false;
      clearInterval(checkInterval);
      nextAlarmText.textContent = "Next alarm: -";
      statusText.textContent = "üõë Alarm is OFF";
      statusText.style.color = "red";
      toggleButton.textContent = "Start Alarm";
    }
  </script>
</body>

</html>